  # Phase 8 â€” JS Sync Client Refactor
  
  **Based on:** V1.5 Implementation Plan (Phase 8), Doc #1 (Playwright Parity)
  **Principle:** Keep the Atomics/Worker bridge mechanism. Refactor everything else to mirror the async client.
  
  Give Claude Code one milestone at a time. Run the checkpoint before moving on. If a checkpoint fails, debug before proceeding.
  
  ---
  
  ## How to use this plan
  
  At the start of each Claude Code session:
  
  > Read docs/plans/v1.5-phase-8-implementation-plan.md. This is **Milestone 8.X**. Here's the scope: [paste milestone section]
  
  ---
  
  ## Architecture Decisions
  
  - **Bridge:** `sync/bridge.ts` (SharedArrayBuffer + Atomics + Worker threads) â€” extended in 8.8 with bidirectional signal protocol for reverse callbacks
  - **Worker registries:** Multi-object tracking by integer ID (`pages`, `contexts`, `elements`, `elementLists` Maps)
  - **Worker dispatch:** `handlers: Record<string, Handler>` dispatch table replaces giant `switch`
  - **Command convention:** `namespace.method` (e.g., `page.go`, `element.click`). Object-scoped commands receive object ID as first arg.
  - **Events:** Static actions (`onDialog('accept')`, `route(pattern, 'abort')`) for simple cases + reverse-bridge callbacks for handler functions (added in 8.8). `consoleMessages()` / `errors()` use collect+drain polling.
  - **No FluentElement:** Sync `find()` returns `ElementSync` directly â€” chaining works naturally.
  - **Import path:** `import { browser } from 'vibium/sync'`
  
  ## File Structure: Before â†’ After
  
  ```
  sync/bridge.ts        EXTENDED â†’ bidirectional signal protocol (8.8)
  sync/browser.ts       REWRITE â†’ BrowserSync class
  sync/vibe.ts          DELETE  â†’ replaced by page.ts
  sync/element.ts       EXPAND  â†’ add missing methods
  sync/worker.ts        REWRITE â†’ multi-page/multi-context dispatch
  sync/index.ts         REWRITE â†’ new exports
  
  NEW FILES:
  sync/page.ts          PageSync class (replaces VibeSync)
  sync/element-list.ts  ElementListSync class
  sync/context.ts       BrowserContextSync class
  sync/keyboard.ts      KeyboardSync, MouseSync, TouchSync
  sync/clock.ts         ClockSync class
  sync/tracing.ts       TracingSync class
  sync/route.ts         RouteSync class (8.8)
  sync/dialog.ts        DialogSync class (8.8)
  ```
  
  ---
  
  ## Milestone 8.1 â€” Worker refactor: multi-object registry + dispatch table
  
  Rewrite worker internals without changing the external API. Existing sync tests must still pass.
  
  ### TODO
  
  - [x] Add object registries to worker: `pages: Map<number, Page>`, `contexts: Map<number, BrowserContext>`, `elements: Map<number, Element>`, `elementLists: Map<number, ElementList>` with ID counters
  - [x] Replace `switch(cmd.method)` with `handlers: Record<string, Handler>` dispatch table
  - [x] Port `launch` â†’ `browser.launch` handler (store browser + default page in registries)
  - [x] Port `quit` â†’ `browser.close` handler (clear all registries)
  - [x] Port `go` â†’ `page.go`, `screenshot` â†’ `page.screenshot`, `evaluate` â†’ `page.evaluate`, `find` â†’ `page.find`
  - [x] Port all `element.*` commands to dispatch table (no behavior change)
  - [x] Keep old command names (`launch`, `go`, `screenshot`, `evaluate`, `find`, `quit`, `element.*`) as aliases
  
  ### Files modified
  - `clients/javascript/src/sync/worker.ts`
  
  ### Checkpoint
  ```bash
  cd clients/javascript && npm run build && cd ../..
  node --test tests/js/sync-api.test.js
  # All existing tests must pass unchanged
  ```
  
  ---
  
  ## Milestone 8.2 â€” BrowserSync + PageSync classes
  
  Create the new class hierarchy. This is the big structural change.
  
  ### TODO
  
  - [x] Create `sync/page.ts` with `PageSync` class
  - [x] PageSync navigation: `go()`, `back()`, `forward()`, `reload()`
  - [x] PageSync info: `url()`, `title()`, `content()`
  - [x] PageSync finding: `find(selector)`, `findAll(selector)`, `waitFor(selector)`
  - [x] PageSync waiting: `wait(ms)`, `waitForURL()`, `waitForLoad()`, `waitForFunction()`
  - [x] PageSync screenshots: `screenshot()`, `pdf()`
  - [x] PageSync evaluation: `evaluate()`, `eval()`, `evalHandle()`, `addScript()`, `addStyle()`
  - [x] PageSync lifecycle: `bringToFront()`, `close()`
  - [x] Rewrite `sync/browser.ts`: `browser` launcher object + `BrowserSync` class
  - [x] BrowserSync: `page()`, `newPage()`, `pages()`, `close()`
  - [x] Add worker handlers: `browser.page`, `browser.newPage`, `browser.pages`, `page.back`, `page.forward`, `page.reload`, `page.url`, `page.title`, `page.content`, `page.waitForURL`, `page.waitForLoad`, `page.waitForFunction`, `page.wait`, `page.pdf`, `page.eval`, `page.evalHandle`, `page.addScript`, `page.addStyle`, `page.bringToFront`, `page.close`, `page.waitFor`, `page.findAll`
  - [x] Update `sync/index.ts` â€” export `browser`, `BrowserSync`, `PageSync`
  - [x] Keep `sync/vibe.ts` as deprecated shim (thin wrapper delegating to PageSync)
  - [x] Add `"./sync"` subpath export to `clients/javascript/package.json`
  - [x] Update `clients/javascript/tsup.config.ts` if needed for sync entry point
  
  ### Files created
  - `clients/javascript/src/sync/page.ts`
  
  ### Files modified
  - `clients/javascript/src/sync/browser.ts`
  - `clients/javascript/src/sync/vibe.ts` (make shim)
  - `clients/javascript/src/sync/index.ts`
  - `clients/javascript/src/sync/worker.ts`
  - `clients/javascript/package.json`
  - `clients/javascript/tsup.config.ts` (if needed)
  
  ### Checkpoint
  ```javascript
  // Test with: node -e "..." or write a quick script
  const { browser } = require('./clients/javascript/dist/sync')
  const bro = browser.launch({ headless: true })
  const vibe = bro.newPage()
  vibe.go('https://example.com')
  console.log(vibe.title())          // â†’ 'Example Domain'
  console.log(vibe.url())            // â†’ 'https://example.com/'
  vibe.back()
  vibe.forward()
  const png = vibe.screenshot()
  console.log(png.length > 1000)     // â†’ true
  const title = vibe.eval('document.title')
  console.log(title)                 // â†’ 'Example Domain'
  bro.close()
  console.log('Milestone 8.2 âœ“')
  ```
  
  Also verify old API still works (backward compat aliases):
  ```javascript
  const { browserSyn } = require('./clients/javascript/dist')
  const vibe = browserSync.launch({ headless: true })
  vibe.go('https://example.com')
  vibe.quit()
  ```
  
  ---
  
  ## Milestone 8.3 â€” ElementSync expansion + ElementListSync
  
  Bring ElementSync to full parity with async Element. Add ElementListSync.
  
  ### TODO
  
  - [x] Create `sync/element-list.ts` with `ElementListSync` class
  - [x] ElementListSync: `count()`, `first()`, `last()`, `nth(index)`, `filter(opts)`, `toArray()`, `[Symbol.iterator]()`
  - [x] Add to ElementSync: `setFiles(files)`
  - [x] Add to ElementSync: `role()`, `label()`
  - [x] Add to ElementSync: `find(selector)` (scoped), `findAll(selector)` (scoped)
  - [x] Add worker handlers: `element.setFiles`, `element.role`, `element.label`, `element.find`, `element.findAll`
  - [x] Add worker handlers: `elementList.count`, `elementList.first`, `elementList.last`, `elementList.nth`, `elementList.filter`, `elementList.toArray`
  - [x] Update `sync/index.ts` â€” export `ElementListSync`
  - [x] `page.findAll()` returns `ElementListSync`
  
  ### Files created
  - `clients/javascript/src/sync/element-list.ts`
  
  ### Files modified
  - `clients/javascript/src/sync/element.ts`
  - `clients/javascript/src/sync/worker.ts`
  - `clients/javascript/src/sync/index.ts`
  
  ### Checkpoint
  ```javascript
  const { browser } = require('./clients/javascript/dist/sync')
  const bro = browser.launch({ headless: true })
  const vibe = bro.newPage()
  vibe.go('https://example.com')
  
  // ElementListSync
  const links = vibe.findAll('a')
  console.log(links.count() > 0)        // â†’ true
  const first = links.first()
  console.log(typeof first.text())       // â†’ 'string'
  
  // Scoped find
  const body = vibe.find('body')
  const nested = body.find('a')
  console.log(typeof nested.text())      // â†’ 'string'
  
  // Iteration
  for (const el of links) {
    console.log(el.text())
    break // just test one
  }
  
  bro.close()
  console.log('Milestone 8.3 âœ“')
  ```
  
  ---
  
  ## Milestone 8.4 â€” KeyboardSync, MouseSync, TouchSync
  
  Add page-level input sub-objects.
  
  ### TODO
  
  - [x] Create `sync/keyboard.ts` with `KeyboardSync`, `MouseSync`, `TouchSync`
  - [x] KeyboardSync: `press(key)`, `down(key)`, `up(key)`, `type(text)`
  - [x] MouseSync: `click(x, y)`, `move(x, y)`, `down()`, `up()`, `wheel(dx, dy)`
  - [x] TouchSync: `tap(x, y)`
  - [x] Add `readonly keyboard: KeyboardSync`, `readonly mouse: MouseSync`, `readonly touch: TouchSync` to PageSync
  - [x] Add worker handlers: `keyboard.press`, `keyboard.down`, `keyboard.up`, `keyboard.type`, `mouse.click`, `mouse.move`, `mouse.down`, `mouse.up`, `mouse.wheel`, `touch.tap` (10 commands, all take pageId as first arg)
  - [x] Update `sync/index.ts` â€” export input classes
  
  ### Files created
  - `clients/javascript/src/sync/keyboard.ts`
  
  ### Files modified
  - `clients/javascript/src/sync/page.ts`
  - `clients/javascript/src/sync/worker.ts`
  - `clients/javascript/src/sync/index.ts`
  
  ### Checkpoint
  ```javascript
  const { browser } = require('./clients/javascript/dist/sync')
  const bro = browser.launch({ headless: true })
  const vibe = bro.newPage()
  vibe.go('https://the-internet.herokuapp.com/inputs')
  vibe.find('input').click()
  vibe.keyboard.type('12345')
  const val = vibe.eval("document.querySelector('input').value")
  console.log(val)                       // â†’ '12345'
  vibe.mouse.click(100, 200)
  bro.close()
  console.log('Milestone 8.4 âœ“')
  ```
  
  ---
  
  ## Milestone 8.5 â€” BrowserContextSync + ClockSync + TracingSync
  
  Add context isolation, clock control, and tracing.
  
  ### TODO
  
  - [x] Create `sync/context.ts` with `BrowserContextSync`
  - [x] BrowserContextSync: `newPage()`, `close()`, `cookies(urls?)`, `setCookies(cookies)`, `clearCookies()`, `storageState()`, `addInitScript(script)`, `readonly tracing: TracingSync`
  - [x] Create `sync/clock.ts` with `ClockSync`
  - [x] ClockSync: `install(opts?)`, `fastForward(ticks)`, `runFor(ticks)`, `pauseAt(time)`, `resume()`, `setFixedTime(time)`, `setSystemTime(time)`, `setTimezone(tz)`
  - [x] Create `sync/tracing.ts` with `TracingSync`
  - [x] TracingSync: `start(opts)`, `stop(opts)`, `startChunk(opts)`, `stopChunk(opts)`, `startGroup(name)`, `stopGroup()`
  - [x] Add `newContext()` to BrowserSync
  - [x] Add `readonly clock: ClockSync` to PageSync
  - [x] Add worker handlers: 7 context + 8 clock + 6 tracing = 21 commands
  - [x] Update `sync/index.ts` â€” export new classes
  
  ### Files created
  - `clients/javascript/src/sync/context.ts`
  - `clients/javascript/src/sync/clock.ts`
  - `clients/javascript/src/sync/tracing.ts`
  
  ### Files modified
  - `clients/javascript/src/sync/browser.ts`
  - `clients/javascript/src/sync/page.ts`
  - `clients/javascript/src/sync/worker.ts`
  - `clients/javascript/src/sync/index.ts`
  
  ### Checkpoint
  ```javascript
  const { browser } = require('./clients/javascript/dist/sync')
  const bro = browser.launch({ headless: true })
  
  // Context isolation
  const ctx = bro.newContext()
  const vibe = ctx.newPage()
  vibe.go('https://example.com')
  ctx.setCookies([{ name: 'test', value: 'val', url: 'https://example.com' }])
  const cookies = ctx.cookies()
  console.log(cookies.some(c => c.name === 'test'))  // â†’ true
  ctx.clearCookies()
  
  // Clock
  const vibe2 = bro.newPage()
  vibe2.go('https://example.com')
  vibe2.clock.install()
  vibe2.clock.setFixedTime(new Date('2025-01-01T00:00:00Z').getTime())
  const year = vibe2.eval('new Date().getFullYear()')
  console.log(year)                                   // â†’ 2025
  
  ctx.close()
  bro.close()
  console.log('Milestone 8.5 âœ“')
  ```
  
  ---
  
  ## Milestone 8.6 â€” Emulation, Frames, Accessibility, Network, Events
  
  All remaining PageSync methods.
  
  ### TODO
  
  **Emulation:**
  - [x] `setViewport(size)`, `viewport()`, `emulateMedia(opts)`, `setContent(html)`, `setGeolocation(coords)`, `setWindow(opts)`, `window()`
  
  **Frames:**
  - [x] `frames()`, `frame(nameOrUrl)`, `mainFrame()`
  
  **Accessibility:**
  - [x] `a11yTree(opts?)`
  
  **Network (static action model):**
  - [x] `route(pattern, action)` â€” action is `'continue'` | `'abort'` | `{ status, body, headers }`
  - [x] `unroute(pattern)`
  - [x] `setHeaders(headers)`
  - [x] `waitForRequest(pattern, opts?)` â€” blocking wait, returns `RequestInfo`
  - [x] `waitForResponse(pattern, opts?)` â€” blocking wait, returns `ResponseInfo`
  
  **Events (simplified model):**
  - [x] `onDialog(action: 'accept' | 'dismiss')` â€” auto-handles dialogs in worker
  - [x] `onConsole('collect')` / `consoleMessages()` â€” buffer + drain
  - [x] `onError('collect')` / `errors()` â€” buffer + drain
  - [x] `removeAllListeners(event?)`
  
  **Browser events:**
  - [x] `browser.waitForPage(opts?)` â€” blocking wait, returns PageSync
  - [x] `browser.waitForPopup(opts?)` â€” blocking wait, returns PageSync
  
  - [x] Add all worker handlers (~25 commands)
  
  ### Files modified
  - `clients/javascript/src/sync/page.ts`
  - `clients/javascript/src/sync/browser.ts`
  - `clients/javascript/src/sync/worker.ts`
  
  ### Checkpoint
  ```javascript
  const { browser } = require('./clients/javascript/dist/sync')
  const bro = browser.launch({ headless: true })
  const vibe = bro.newPage()
  vibe.go('https://example.com')
  
  // Emulation
  vibe.setViewport({ width: 375, height: 812 })
  console.log(vibe.viewport().width)                 // â†’ 375
  
  // Accessibility
  const tree = vibe.a11yTree()
  console.log(typeof tree)                           // â†’ 'object'
  
  // Dialog auto-handling
  vibe.onDialog('accept')
  vibe.eval('alert("hello")')                        // auto-accepted, no hang
  
  // Network
  vibe.route('**/api/**', 'abort')
  
  bro.close()
  console.log('Milestone 8.6 âœ“')
  ```
  
  ---
  
  ## Milestone 8.7 â€” Exports, Tests, Cleanup
  
  Finalize everything, delete deprecated code, write comprehensive tests.
  
  ### TODO
  
  - [x] Delete `sync/vibe.ts`
  - [x] Remove backward-compat aliases from worker (old command names from 8.1)
  - [x] Finalize `sync/index.ts` exports: `browser`, `BrowserSync`, `PageSync`, `ElementSync`, `ElementListSync`, `BrowserContextSync`, `KeyboardSync`, `MouseSync`, `TouchSync`, `ClockSync`, `TracingSync`, plus shared types
  - [x] Update `clients/javascript/src/index.ts` â€” remove deprecated `browserSync`/`VibeSync` exports, add sync subpath re-exports
  - [x] Confirm `"./sync"` subpath in `package.json` works
  - [x] Update `tsup.config.ts` if sync needs separate bundle entry
  - [x] Rewrite `tests/js/sync-api.test.js` â€” comprehensive suite with local HTTP server:
    - [x] Browser lifecycle (launch, close)
    - [x] Multi-page (newPage, pages, bringToFront, close)
    - [x] Navigation (go, url, title, content, back, forward, reload)
    - [x] Screenshots + PDF
    - [x] Evaluation (evaluate, eval)
    - [x] Element finding (find, findAll, scoped find, semantic selectors)
    - [x] ElementListSync (count, first, last, nth, filter, iteration)
    - [x] Element interaction (click, fill, type, press, check/uncheck, selectOption, hover, focus)
    - [x] Element state (text, innerText, html, value, attr, bounds, isVisible, isEnabled, isChecked, isEditable, role, label)
    - [x] Keyboard, mouse, touch
    - [x] Clock control
    - [x] Viewport/emulation
    - [x] Context isolation + cookies
    - [x] Dialog auto-handling
    - [x] waitForRequest / waitForResponse (with local server)
  - [x] Update `areweplaywrightyet.md` JS sync column
  
  ### Files deleted
  - `clients/javascript/src/sync/vibe.ts`
  
  ### Files modified
  - `clients/javascript/src/sync/index.ts`
  - `clients/javascript/src/sync/worker.ts`
  - `clients/javascript/src/index.ts`
  - `clients/javascript/package.json`
  - `clients/javascript/tsup.config.ts`
  - `tests/js/sync-api.test.js`
  - `docs/trackers/areweplaywrightyet.md`
  
  ### Checkpoint
  
  Full Phase 8 checkpoint:
  ```javascript
  const { browser } = require('./clients/javascript/dist/sync')
  
  const bro = browser.launch({ headless: true })
  const vibe = bro.newPage()
  vibe.go('https://example.com')
  console.log(vibe.title())                         // â†’ 'Example Domain'
  console.log(vibe.url())                            // â†’ 'https://example.com/'
  
  // Find + interact
  vibe.find({ role: 'link' }).click()
  console.log(vibe.url())                            // â†’ iana.org URL
  
  // Screenshot
  const png = vibe.screenshot()
  console.log(png.length > 1000)                     // â†’ true
  
  // Eval
  const year = vibe.eval('new Date().getFullYear()')
  console.log(typeof year)                           // â†’ 'number'
  
  bro.close()
  console.log('Phase 8 âœ“')
  ```
  
  ```bash
  make test  # All tests pass
  ```
  
  ---
  
  ## Milestone 8.8 â€” Reverse-Bridge Callbacks (route & dialog handlers)

  Upgrade `route()` and `onDialog()` from static-action-only (ðŸŸ¡) to full handler function support (âœ…). This required extending the bridge from unidirectional (mainâ†’worker) to bidirectional, so closures can effectively cross the thread boundary.

  ### Problem

  The SyncBridge only supported mainâ†’worker calls. There was no way for the worker to invoke a callback on the main thread mid-command (e.g., when a route intercept fires during `page.go()`).

  ### Solution: Bidirectional Signal Protocol

  Extended `SharedArrayBuffer` from 1 slot to 2 slots, added a persistent `MessagePort` pair for callback data, and modified `call()` to handle mid-command callbacks.

  **Signal protocol:**
  ```
  signal[0]: worker â†’ main    (0=idle, 1=result ready, 2=callback needed)
  signal[1]: main â†’ worker    (0=idle, 1=callback response ready)
  ```

  **Callback flow during a command:**
  1. Worker serializes event data â†’ callback port, sets `signal[0]=2`, notifies
  2. Main thread wakes, sees `signal[0]=2`, reads data via `receiveMessageOnPort`, runs handler
  3. Main thread posts decision back, resets `signal[0]=0`, waits again
  4. Worker reads decision via `port.once('message')`, applies it (fulfill/continue/abort/accept/dismiss)
  5. Original command eventually completes â†’ `signal[0]=1` â†’ main thread returns result

  **Key implementation details:**
  - Spin-wait in `handleCallback()` for port message (Atomics signal is instant, postMessage is async)
  - `processPendingCallbacks()` at start of each `call()` for callbacks between bridge calls
  - Async mutex (promise chain) in worker to serialize concurrent `invokeMainThread` calls
  - `port.once('message')` on worker side for reliable response receipt

  ### TODO

  - [x] Create `sync/route.ts` â€” `RouteSync` class with `request` property, `fulfill()`, `continue()`, `abort()` methods
  - [x] Create `sync/dialog.ts` â€” `DialogSync` class with `type()`, `message()`, `defaultValue()` readers, `accept(text?)`, `dismiss()` methods
  - [x] Extend `sync/bridge.ts` â€” 2-slot SharedArrayBuffer, callback MessagePort pair, handler registry, bidirectional `call()` loop
  - [x] Extend `sync/worker.ts` â€” `invokeMainThread()` with async mutex, `page.routeWithCallback` and `page.onDialogWithCallback` handlers
  - [x] Extend `sync/page.ts` â€” handler overloads for `route()` and `onDialog()`, cleanup in `unroute()` and `removeAllListeners()`
  - [x] Export `RouteSync`, `DialogSync` from `sync/index.ts`
  - [x] Add test server endpoints (`/api/data`, `/prompt`, `/fetch`)
  - [x] Add 13 new tests: 6 route handler + 7 dialog handler
  - [x] Update `areweplaywrightyet.md` â€” route/dialog/console/error/page/popup â†’ âœ…

  ### API

  ```typescript
  // Route handler â€” inspect requests, make conditional decisions
  vibe.route('**/api/**', (route) => {
    if (route.request.url.includes('/data')) {
      route.fulfill({ status: 200, body: '{"mock": true}' });
    } else {
      route.continue();
    }
  });

  // Dialog handler â€” read message, provide prompt text
  vibe.onDialog((dialog) => {
    if (dialog.type() === 'prompt') dialog.accept('answer');
    else dialog.dismiss();
  });

  // Static actions still work alongside handlers
  vibe.route('**/ads/**', 'abort');
  vibe.onDialog('accept');
  ```

  ### Files created
  - `clients/javascript/src/sync/route.ts`
  - `clients/javascript/src/sync/dialog.ts`

  ### Files modified
  - `clients/javascript/src/sync/bridge.ts`
  - `clients/javascript/src/sync/worker.ts`
  - `clients/javascript/src/sync/page.ts`
  - `clients/javascript/src/sync/index.ts`
  - `tests/js/sync-api.test.js`
  - `tests/js/sync-test-server.js`
  - `docs/trackers/areweplaywrightyet.md`

  ### Checkpoint
  ```bash
  make test  # All 252 tests pass
  ```

  ---

  ## Summary
  
  | Milestone | Focus | New Worker Commands |
  |-----------|-------|-------------------|
  | 8.1 | Worker internals refactor | 0 (ports existing) |
  | 8.2 | BrowserSync + PageSync | ~22 |
  | 8.3 | ElementSync + ElementListSync | ~11 |
  | 8.4 | Keyboard, Mouse, Touch | 10 |
  | 8.5 | Context, Clock, Tracing | 21 |
  | 8.6 | Emulation, Frames, A11y, Network, Events | ~25 |
  | 8.7 | Exports, Tests, Cleanup | 0 |
  | 8.8 | Reverse-Bridge Callbacks (route/dialog) | 2 |

  **Status:** All milestones complete. 252 tests passing.

  **Total new worker commands:** ~91 (on top of 41 existing, totaling ~132)

  **Key files:**
  - `clients/javascript/src/sync/worker.ts` â€” modified in every milestone
  - `clients/javascript/src/sync/page.ts` â€” ~50 methods, largest sync class
  - `clients/javascript/src/sync/bridge.ts` â€” extended in 8.8 with bidirectional signal protocol
  - `clients/javascript/src/page.ts` â€” async reference (consult for every PageSync method)
  - `clients/javascript/src/element.ts` â€” async reference for ElementSync expansion
